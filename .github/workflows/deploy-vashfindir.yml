name: Deploy vashfindir to production

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy over SSH to vashfindir server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -euo pipefail

            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            COMPOSE_FILE="${DEPLOY_PATH}/docker-compose.prod.yml"

            echo "==> cd ${DEPLOY_PATH}"
            cd "${DEPLOY_PATH}"

            sudo /usr/local/sbin/vashfindir-fix-wp-perms || true
            echo "==> git sync (hard reset to origin/master)"
            git fetch --all --prune
            # Если у тебя основная ветка main, поменяй origin/master на origin/main
            git reset --hard origin/master
            git clean -fd

            echo "==> export DB secrets (from GitHub Secrets)"
            export VF_DB_PASSWORD='${{ secrets.VF_DB_PASSWORD }}'
            export VF_DB_ROOT_PASSWORD='${{ secrets.VF_DB_ROOT_PASSWORD }}'

            echo "==> sanity: render docker-compose config"
            docker-compose -f "${COMPOSE_FILE}" config > /tmp/vashfindir.compose.rendered.yml
            # Печатаем верх конфига для контроля, что файл тот и сервисы есть
            sed -n '1,120p' /tmp/vashfindir.compose.rendered.yml

            echo "==> stop stack (ignore errors)"
            docker-compose -f "${COMPOSE_FILE}" down || true

            echo "==> remove orphan containers (ignore errors)"
            docker rm -f vashfindir_wp vashfindir_db 2>/dev/null || true

            echo "==> start stack"
            docker-compose -f "${COMPOSE_FILE}" up -d --remove-orphans

            echo "==> status"
            docker-compose -f "${COMPOSE_FILE}" ps

            echo "==> logs: db (tail)"
            docker-compose -f "${COMPOSE_FILE}" logs --tail=120 db || true

            echo "==> logs: wordpress (tail)"
            docker-compose -f "${COMPOSE_FILE}" logs --tail=120 wordpress || true
