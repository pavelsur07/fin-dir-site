version: "3.9"

services:
  db:
    image: mariadb:11
    container_name: vashfindir_db
    restart: always
    environment:
      # НЕ секретные вещи — можно захардкодить
      MYSQL_DATABASE: vashfindir_wp
      MYSQL_USER: vashfindir_user

      # Секреты — только через переменные окружения
      # Эти переменные должны быть заданы снаружи (в shell, в GitHub Actions и т.д.)
      MYSQL_PASSWORD: ${VFR_DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${VF_DB_ROOT_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - internal

  wordpress:
    image: wordpress:php8.2-apache
    container_name: vashfindir_wp
    restart: always
    depends_on:
      - db
    environment:
      WORDPRESS_DB_HOST: db:3306

      # Те же имя базы и юзер, что в db
      WORDPRESS_DB_NAME: vashfindir_wp
      WORDPRESS_DB_USER: vashfindir_user

      # Пароль БД — из переменной окружения (тот же, что MYSQL_PASSWORD)
      WORDPRESS_DB_PASSWORD: ${VF_DB_PASSWORD}

      # Не секрет — можно захардкодить
      WORDPRESS_TABLE_PREFIX: wp_
    volumes:
      # wp-content берём из репозитория (тема, плагины и т.п.)
      - ./wp-content:/var/www/html/wp-content
    labels:
      - "traefik.enable=true"

      # HTTPS-роутер для vashfindir.ru
      - "traefik.http.routers.vashfindir.rule=Host(`vashfindir.ru`,`www.vashfindir.ru`)"
      - "traefik.http.routers.vashfindir.entrypoints=websecure"
      - "traefik.http.routers.vashfindir.tls.certresolver=le"

      # HTTP -> HTTPS (редирект)
      - "traefik.http.routers.vashfindir-http.rule=Host(`vashfindir.ru`,`www.vashfindir.ru`)"
      - "traefik.http.routers.vashfindir-http.entrypoints=web"
      - "traefik.http.routers.vashfindir-http.middlewares=vashfindir-https-redirect"
      - "traefik.http.middlewares.vashfindir-https-redirect.redirectscheme.scheme=https"
    networks:
      - web
      - internal

networks:
  # Внешняя сеть Traefik — имя должно совпадать с тем, что создаёт docker-compose Traefik.
  # Если у тебя compose-проект Traefik называется "traefik", то сеть будет "traefik_web".
  web:
    external: true
    name: traefik_web

  # Внутренняя сеть между WP и БД
  internal:
    external: false

volumes:
  db_data:
